{% extends "base.html" %}

{% block title %}Analytics Dashboard - Team Update Tracker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
            <p class="text-gray-600">Comprehensive team performance and productivity insights</p>
        </div>
        <div class="flex space-x-3">
            <button id="refresh-analytics" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                Refresh Data
            </button>
            <button id="export-report" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Export Report
            </button>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Cards</p>
                    <p class="text-2xl font-bold text-gray-900" id="total-cards">0</p>
                    <p class="text-xs text-green-600" id="total-cards-change">+0% vs last month</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="clock" class="w-6 h-6 text-orange-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Pending Updates</p>
                    <p class="text-2xl font-bold text-gray-900" id="pending-updates">0</p>
                    <p class="text-xs text-red-600" id="pending-updates-change">+0% vs yesterday</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="trending-up" class="w-6 h-6 text-green-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Response Rate</p>
                    <p class="text-2xl font-bold text-gray-900" id="response-rate">0%</p>
                    <p class="text-xs text-green-600" id="response-rate-change">+0% vs last week</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="message-circle" class="w-6 h-6 text-purple-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Messages Sent</p>
                    <p class="text-2xl font-bold text-gray-900" id="messages-sent">0</p>
                    <p class="text-xs text-blue-600" id="messages-sent-change">+0 today</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Team Performance Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i data-lucide="bar-chart" class="w-5 h-5 mr-2"></i>
                    Team Performance
                </h2>
            </div>
            <div class="p-6">
                <div id="team-performance-chart" class="h-64">
                    <!-- Chart will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Response Trends Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                    Response Trends
                </h2>
            </div>
            <div class="p-6">
                <div id="response-trends-chart" class="h-64">
                    <!-- Chart will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Team Member Performance -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                Team Member Performance
            </h2>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Cards</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active Cards</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Update Requests</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="team-performance-table" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Board Performance -->
    <div class="bg-white rounded-xl shadow-md border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i data-lucide="trello" class="w-5 h-5 mr-2"></i>
                Board Performance
            </h2>
        </div>
        <div class="p-6">
            <div id="board-performance" class="space-y-4">
                <!-- Board performance cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Escalation Alerts -->
    <div id="escalation-alerts" class="bg-white rounded-xl shadow-md border border-red-200 hidden">
        <div class="p-6 border-b border-red-200 bg-red-50">
            <h2 class="text-lg font-semibold text-red-900 flex items-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                Escalation Alerts
            </h2>
        </div>
        <div class="p-6">
            <div id="escalation-list" class="space-y-4">
                <!-- Escalation alerts will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let analyticsData = {};

    async function loadAnalytics() {
        const refreshBtn = document.getElementById('refresh-analytics');
        const originalText = refreshBtn.innerHTML;
        showLoading(refreshBtn);

        try {
            const response = await fetch('/api/analytics');
            const data = await response.json();

            if (data.success !== false) {
                analyticsData = data;
                updateDashboard(data);
                showNotification('Analytics updated successfully', 'success');
            } else {
                showNotification(data.error || 'Failed to load analytics', 'error');
            }
        } catch (error) {
            showNotification('Error loading analytics: ' + error.message, 'error');
        } finally {
            hideLoading(refreshBtn, originalText);
        }
    }

    function updateDashboard(data) {
        // Update key metrics
        document.getElementById('total-cards').textContent = data.overall_stats?.total_cards || 0;
        document.getElementById('pending-updates').textContent = data.total_cards_tracked || 0;
        document.getElementById('messages-sent').textContent = data.update_requests_sent || 0;
        
        // Calculate overall response rate
        const totalAssigned = data.overall_stats?.assigned_cards || 1;
        const totalActive = data.overall_stats?.cards_with_recent_activity || 0;
        const overallResponseRate = Math.round((totalActive / totalAssigned) * 100);
        document.getElementById('response-rate').textContent = overallResponseRate + '%';

        // Update team performance table
        updateTeamPerformanceTable(data.team_performance || {});
        
        // Update board performance
        updateBoardPerformance(data.board_performance || {});
        
        // Check for escalations
        checkEscalations(data.team_performance || {});
        
        // Render charts
        renderTeamPerformanceChart(data.team_performance || {});
        renderResponseTrendsChart();
    }

    function updateTeamPerformanceTable(teamPerformance) {
        const tbody = document.getElementById('team-performance-table');
        
        tbody.innerHTML = Object.entries(teamPerformance).map(([member, stats]) => {
            const responseRate = Math.round(stats.response_rate || 0);
            const statusClass = responseRate >= 80 ? 'bg-green-100 text-green-800' : 
                               responseRate >= 60 ? 'bg-yellow-100 text-yellow-800' : 
                               'bg-red-100 text-red-800';
            const statusText = responseRate >= 80 ? 'Excellent' : 
                              responseRate >= 60 ? 'Good' : 'Needs Attention';
            
            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-sm font-medium text-blue-600">${member[0]}</span>
                            </div>
                            <span class="text-sm font-medium text-gray-900">${member}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.assigned_cards || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.active_cards || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${responseRate}%"></div>
                            </div>
                            <span class="text-sm text-gray-900">${responseRate}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.update_requests_sent || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateBoardPerformance(boardPerformance) {
        const container = document.getElementById('board-performance');
        
        if (Object.keys(boardPerformance).length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    <p>No board performance data available</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        container.innerHTML = Object.entries(boardPerformance).map(([boardName, stats]) => {
            const activityRate = stats.total_cards > 0 ? Math.round((stats.active_cards / stats.total_cards) * 100) : 0;
            
            return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900">${boardName}</h3>
                        <span class="text-sm text-gray-500">${activityRate}% active</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Total Cards</p>
                            <p class="font-semibold">${stats.total_cards || 0}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Assigned</p>
                            <p class="font-semibold">${stats.assigned_cards || 0}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Active</p>
                            <p class="font-semibold">${stats.active_cards || 0}</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: ${activityRate}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function checkEscalations(teamPerformance) {
        const escalationContainer = document.getElementById('escalation-alerts');
        const escalationList = document.getElementById('escalation-list');
        
        const escalations = Object.entries(teamPerformance).filter(([member, stats]) => {
            return (stats.update_requests_sent || 0) >= 3 || (stats.response_rate || 0) < 30;
        });

        if (escalations.length > 0) {
            escalationContainer.classList.remove('hidden');
            
            escalationList.innerHTML = escalations.map(([member, stats]) => `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-red-900">${member}</h4>
                            <p class="text-sm text-red-700">
                                ${stats.update_requests_sent >= 3 ? 
                                  `${stats.update_requests_sent} update requests sent` : 
                                  `${Math.round(stats.response_rate)}% response rate`}
                            </p>
                        </div>
                        <button class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors">
                            Contact
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            escalationContainer.classList.add('hidden');
        }
    }

    function renderTeamPerformanceChart(teamPerformance) {
        const chartContainer = document.getElementById('team-performance-chart');
        
        // Simple bar chart representation
        const members = Object.keys(teamPerformance);
        const maxCards = Math.max(...Object.values(teamPerformance).map(stats => stats.assigned_cards || 0), 1);
        
        chartContainer.innerHTML = `
            <div class="space-y-2">
                ${members.map(member => {
                    const stats = teamPerformance[member];
                    const assigned = stats.assigned_cards || 0;
                    const active = stats.active_cards || 0;
                    const assignedWidth = (assigned / maxCards) * 100;
                    const activeWidth = (active / maxCards) * 100;
                    
                    return `
                        <div class="flex items-center space-x-3">
                            <div class="w-20 text-xs text-gray-600 text-right">${member}</div>
                            <div class="flex-1 relative">
                                <div class="bg-gray-200 rounded h-6 relative">
                                    <div class="bg-blue-200 rounded h-6 absolute top-0 left-0" style="width: ${assignedWidth}%"></div>
                                    <div class="bg-blue-600 rounded h-6 absolute top-0 left-0" style="width: ${activeWidth}%"></div>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">${active}/${assigned}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            <div class="mt-4 flex items-center space-x-4 text-xs text-gray-600">
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-blue-200 rounded"></div>
                    <span>Assigned</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-blue-600 rounded"></div>
                    <span>Active</span>
                </div>
            </div>
        `;
    }

    function renderResponseTrendsChart() {
        const chartContainer = document.getElementById('response-trends-chart');
        
        // Placeholder for trends chart
        chartContainer.innerHTML = `
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <i data-lucide="trending-up" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p class="text-sm">Response trends visualization</p>
                    <p class="text-xs">Coming soon with historical data</p>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    async function exportReport() {
        try {
            const reportData = {
                timestamp: new Date().toISOString(),
                analytics: analyticsData
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `team-analytics-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Report exported successfully', 'success');
        } catch (error) {
            showNotification('Error exporting report: ' + error.message, 'error');
        }
    }

    // Event listeners
    document.getElementById('refresh-analytics').addEventListener('click', loadAnalytics);
    document.getElementById('export-report').addEventListener('click', exportReport);

    // Load analytics on page load
    document.addEventListener('DOMContentLoaded', loadAnalytics);
    
    // Auto-refresh every 5 minutes
    setInterval(loadAnalytics, 5 * 60 * 1000);
</script>
{% endblock %}