{% extends "base.html" %}

{% block title %}Gmail Tracker - JGV AI Hub{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üìß Gmail Tracker & Informer</h1>
                    <p class="text-gray-600 mt-1">AI-powered email analysis with automated team notifications</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                        GPT-5 Powered
                    </span>
                    <a href="/team-tracker" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Team Tracker ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Control Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üìä Gmail Scanner Control</h2>
            <div class="flex items-center space-x-4">
                <button onclick="manualScan()" 
                        id="scanBtn"
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all">
                    üîÑ Manual Scan
                </button>
                <button onclick="refreshHistory()" 
                        id="refreshBtn"
                        class="px-6 py-3 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-all">
                    üìã Refresh History
                </button>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">Automation: OFF</span>
                    </div>
                    <button onclick="showMessageTemplates()" 
                            class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm">
                        üì± View Message Templates
                    </button>
                </div>
            </div>
        </div>

        <!-- Email Watch Configuration -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">‚öôÔ∏è Email Watch Configuration</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium mb-3">üìù Add Custom Email Watch</h4>
                    <div class="space-y-3">
                        <input type="text" 
                               id="watchSubject" 
                               placeholder="Subject filter (e.g., 'New Tech Onboarding')" 
                               value="New Tech Onboarding"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <input type="text" 
                               id="watchSender" 
                               placeholder="Sender email or name (optional)" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <select id="watchAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="James Taylor">James Taylor</option>
                            <option value="Ezechiel">Ezechiel</option>
                            <option value="Levy">Levy</option>
                            <option value="Wendy">Wendy</option>
                            <option value="Forka">Forka</option>
                            <option value="Breyden">Breyden</option>
                            <option value="Brayan">Brayan</option>
                            <option value="Dustin Salinas">Dustin Salinas</option>
                        </select>
                        <input type="text" 
                               id="watchNotes" 
                               placeholder="Notes (e.g., 'Important client emails')" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <button onclick="addEmailWatch()" 
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ‚ûï Add Watch Rule
                        </button>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-3">üë• Current Watch Rules</h4>
                    <div id="watchRules" class="space-y-2 text-sm">
                        <!-- Watch rules will be populated here -->
                    </div>
                    <div class="mt-4 space-y-2">
                        <button onclick="showAddTeamMember()" 
                                class="w-full px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm">
                            ‚ûï Add Team Member
                        </button>
                        <button onclick="showTeamManagement()" 
                                class="w-full px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm">
                            üë• Manage Team Members
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Automation Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">ü§ñ Automation Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium mb-3">‚è∞ Scheduled Scanning</h4>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="enableAutoScan" class="w-4 h-4 text-blue-600 rounded">
                            <label for="enableAutoScan" class="text-sm font-medium">Enable automatic scanning</label>
                        </div>
                        <div class="pl-7 space-y-3">
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Scan frequency:</label>
                                <select id="scanFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="hourly">Every hour</option>
                                    <option value="every2hours">Every 2 hours</option>
                                    <option value="every6hours">Every 6 hours</option>
                                    <option value="daily" selected>Twice daily (6 AM & 6 PM)</option>
                                    <option value="custom">Custom schedule</option>
                                </select>
                            </div>
                            <div id="customSchedule" class="hidden space-y-2">
                                <input type="time" id="scanTime1" value="06:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                                <input type="time" id="scanTime2" value="18:00" class="px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-3">üîî Notification Routing</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-2">When emails are found, send notifications to:</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="notificationRoute" value="individual" checked class="mr-2">
                                    <span class="text-sm">üë§ Individual team member only</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="notificationRoute" value="group" class="mr-2">
                                    <span class="text-sm">üë• Group chat only</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="notificationRoute" value="both" class="mr-2">
                                    <span class="text-sm">üì¢ Both individual and group</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="notificationRoute" value="off" class="mr-2">
                                    <span class="text-sm">üîï No notifications (scan only)</span>
                                </label>
                            </div>
                        </div>
                        <div class="pt-3 border-t">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="enableSummary" class="w-4 h-4 text-blue-600 rounded">
                                <label for="enableSummary" class="text-sm">Send daily summary reports</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="resetSettings()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Reset to Defaults
                </button>
                <button onclick="saveAutomationSettings()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üíæ Save Settings
                </button>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Emails Today</p>
                        <p class="text-2xl font-bold text-gray-900" id="emailsToday">-</p>
                    </div>
                    <span class="text-3xl">üìß</span>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Notifications Sent</p>
                        <p class="text-2xl font-bold text-gray-900" id="notificationsSent">-</p>
                    </div>
                    <span class="text-3xl">üîî</span>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">High Priority</p>
                        <p class="text-2xl font-bold text-red-600" id="highPriority">-</p>
                    </div>
                    <span class="text-3xl">üö®</span>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Team Members</p>
                        <p class="text-2xl font-bold text-gray-900" id="teamMembers">4</p>
                    </div>
                    <span class="text-3xl">üë•</span>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 mb-4">
                    <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="text-gray-600 text-lg">Scanning emails...</p>
                <p class="text-gray-500 text-sm mt-2">Analyzing with AI and sending notifications</p>
            </div>
        </div>

        <!-- Email History -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">üìã Email Processing History</h3>
                <div class="flex items-center space-x-2">
                    <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">All Categories</option>
                        <option value="onboarding">Onboarding</option>
                        <option value="ghl_support">GHL Support</option>
                        <option value="tech_issues">Tech Issues</option>
                        <option value="client_communication">Client Communication</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="assigneeFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">All Assignees</option>
                        <option value="James Taylor">James Taylor</option>
                        <option value="Ezechiel">Ezechiel</option>
                        <option value="Levy">Levy</option>
                        <option value="Wendy">Wendy</option>
                        <option value="Forka">Forka</option>
                        <option value="Breyden">Breyden</option>
                        <option value="Brayan">Brayan</option>
                        <option value="Dustin Salinas">Dustin Salinas</option>
                    </select>
                    <button onclick="clearEmailHistory()" 
                            class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm">
                        üóëÔ∏è Clear History
                    </button>
                </div>
            </div>
            
            <div id="emailHistory" class="space-y-3">
                <!-- Email history will be populated here -->
                <div class="text-center py-8 text-gray-500">
                    <p>üìß No email history available</p>
                    <p class="text-sm mt-1">Run a scan to see processed emails</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Add Team Member Modal -->
    <div id="addTeamMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Team Member</h3>
                <button onclick="closeTeamMemberModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form onsubmit="handleAddTeamMember(event)">
                <div class="space-y-4">
                    <div>
                        <label for="modalMemberName" class="block text-sm font-medium text-gray-700 mb-1">Team Member Name</label>
                        <input type="text" 
                               id="modalMemberName" 
                               required
                               placeholder="e.g., John Doe" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="modalMemberPhone" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number</label>
                        <input type="text" 
                               id="modalMemberPhone" 
                               required
                               placeholder="e.g., 1234567890@c.us" 
                               pattern="[0-9]+@c\.us"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Format: number@c.us (e.g., 1234567890@c.us)</p>
                    </div>
                    
                    <div>
                        <label for="modalMemberRole" class="block text-sm font-medium text-gray-700 mb-1">Role/Department (optional)</label>
                        <input type="text" 
                               id="modalMemberRole" 
                               placeholder="e.g., Developer, Designer, Manager" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" 
                            onclick="closeTeamMemberModal()" 
                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Management Modal -->
    <div id="teamManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Manage Team Members</h3>
                <button onclick="closeTeamManagementModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="max-h-96 overflow-y-auto">
                <div id="teamMembersList" class="space-y-3">
                    <!-- Team members will be populated here -->
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeTeamManagementModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Message Templates Modal -->
    <div id="messageTemplatesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">üì± WhatsApp Message Templates</h3>
                <button onclick="closeMessageTemplatesModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium mb-3 text-blue-600">üë§ Individual Team Member Message</h4>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <pre class="text-sm text-gray-800 whitespace-pre-wrap">üìß NEW ONBOARDING EMAIL ALERT

üë§ From: [sender email]
üìã Subject: [email subject]
üè∑Ô∏è Category: onboarding
‚ö° Priority: [1-5]/5

üìù Summary: [AI-generated summary]

üîó Keywords: [extracted keywords]

Please check your email and respond as needed.

- JGV Gmail Tracker</pre>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-3 text-green-600">üë• Group Chat Message</h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <pre class="text-sm text-gray-800 whitespace-pre-wrap">üéØ NEW TECH ONBOARDING TRACKER

üìß Found: [X] new onboarding email(s)
üë§ Assigned to: [Team Member Name]
üîî Notifications sent: [X]
‚è∞ Scan time: [HH:MM AM/PM]

All onboarding emails have been flagged for immediate attention.

- JGV Onboarding Tracker (Automated)</pre>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h5 class="font-medium text-yellow-800 mb-2">üìã Message Variables Available:</h5>
                <div class="text-sm text-yellow-700 grid grid-cols-2 gap-2">
                    <span>‚Ä¢ [sender email] - From address</span>
                    <span>‚Ä¢ [email subject] - Subject line</span>
                    <span>‚Ä¢ [AI-generated summary] - AI analysis</span>
                    <span>‚Ä¢ [extracted keywords] - Found keywords</span>
                    <span>‚Ä¢ [Team Member Name] - Assigned person</span>
                    <span>‚Ä¢ [1-5]/5 - Priority level</span>
                    <span>‚Ä¢ [X] - Email count</span>
                    <span>‚Ä¢ [HH:MM AM/PM] - Current time</span>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeMessageTemplatesModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let emailHistory = [];

// Load email history on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshHistory();
});

async function manualScan() {
    const scanBtn = document.getElementById('scanBtn');
    const loadingState = document.getElementById('loadingState');
    
    scanBtn.disabled = true;
    scanBtn.textContent = '‚è≥ Scanning...';
    loadingState.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/gmail-scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Gmail scan completed successfully!', 'success');
            setTimeout(() => refreshHistory(), 2000);
        } else {
            showNotification('Scan failed: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Failed to start scan', 'error');
    } finally {
        loadingState.classList.add('hidden');
        scanBtn.disabled = false;
        scanBtn.textContent = 'üîÑ Manual Scan';
    }
}

async function refreshHistory() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;
    refreshBtn.textContent = '‚è≥ Loading...';
    
    try {
        const response = await fetch('/api/gmail-history?limit=50');
        const data = await response.json();
        
        if (data.success) {
            emailHistory = data.emails;
            displayEmailHistory();
            updateStatistics();
            showNotification('History refreshed', 'success');
        } else {
            showNotification('Failed to load history: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Failed to load email history', 'error');
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üìã Refresh History';
    }
}

function displayEmailHistory() {
    const container = document.getElementById('emailHistory');
    const categoryFilter = document.getElementById('categoryFilter').value;
    const assigneeFilter = document.getElementById('assigneeFilter').value;
    
    // Filter emails
    let filteredEmails = emailHistory;
    if (categoryFilter) {
        filteredEmails = filteredEmails.filter(email => email.category === categoryFilter);
    }
    if (assigneeFilter) {
        filteredEmails = filteredEmails.filter(email => email.assigned_to === assigneeFilter);
    }
    
    if (filteredEmails.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>üìß No emails found</p>
                <p class="text-sm mt-1">Try adjusting your filters or run a scan</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredEmails.map(email => `
        <div class="flex items-start space-x-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
            <div class="flex-shrink-0">
                ${getPriorityIcon(email.priority)}
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-900 truncate">${email.subject}</h4>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getCategoryColor(email.category)}">
                            ${email.category}
                        </span>
                        ${email.whatsapp_sent ? '<span class="text-green-600 text-xs">‚úì Sent</span>' : '<span class="text-gray-400 text-xs">‚óã Not sent</span>'}
                    </div>
                </div>
                <p class="text-sm text-gray-600 truncate mt-1">From: ${email.sender}</p>
                <div class="flex items-center justify-between mt-2">
                    <span class="text-xs text-gray-500">Assigned to: ${email.assigned_to || 'Unassigned'}</span>
                    <span class="text-xs text-gray-400">${formatDate(email.processed_at)}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function updateStatistics() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayEmails = emailHistory.filter(email => {
        const emailDate = new Date(email.processed_at);
        emailDate.setHours(0, 0, 0, 0);
        return emailDate.getTime() === today.getTime();
    });
    
    const notifications = emailHistory.filter(email => email.whatsapp_sent);
    const highPriority = emailHistory.filter(email => email.priority >= 4);
    
    document.getElementById('emailsToday').textContent = todayEmails.length;
    document.getElementById('notificationsSent').textContent = notifications.length;
    document.getElementById('highPriority').textContent = highPriority.length;
}

function getPriorityIcon(priority) {
    if (priority >= 4) return '<span class="text-red-500 text-lg">üö®</span>';
    if (priority >= 3) return '<span class="text-yellow-500 text-lg">‚ö†Ô∏è</span>';
    return '<span class="text-blue-500 text-lg">üìß</span>';
}

function getCategoryColor(category) {
    const colors = {
        'onboarding': 'bg-green-100 text-green-800',
        'ghl_support': 'bg-blue-100 text-blue-800',
        'tech_issues': 'bg-red-100 text-red-800',
        'client_communication': 'bg-purple-100 text-purple-800',
        'other': 'bg-gray-100 text-gray-800'
    };
    return colors[category] || colors['other'];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

// Watch rules storage - start empty
let watchRules = [];

// Team members storage - complete list from main app
let teamMembers = [
    { name: 'James Taylor', phone: '19056064550@c.us' },
    { name: 'Ezechiel', phone: '23754071907@c.us' },
    { name: 'Levy', phone: '237659250977@c.us' },
    { name: 'Wendy', phone: '237677079267@c.us' },
    { name: 'Forka', phone: '237652275097@c.us' },
    { name: 'Breyden', phone: '13179979692@c.us' },
    { name: 'Brayan', phone: '237676267420@c.us' },
    { name: 'Dustin Salinas', phone: '19054251997@c.us' }
];

function addEmailWatch() {
    const subject = document.getElementById('watchSubject').value.trim();
    const sender = document.getElementById('watchSender').value.trim();
    const assignee = document.getElementById('watchAssignee').value;
    const notes = document.getElementById('watchNotes').value.trim();
    
    if (!subject || !assignee) {
        showNotification('Please fill in subject and assignee fields', 'error');
        return;
    }
    
    // Add to watch rules
    watchRules.push({
        subject: subject,
        sender: sender,
        assignee: assignee,
        notes: notes || 'Custom watch rule'
    });
    
    updateWatchRulesDisplay();
    showNotification(`Email watch added: "${subject}" ‚Üí ${assignee}`, 'success');
    
    // Clear form
    document.getElementById('watchSubject').value = '';
    document.getElementById('watchSender').value = '';
    document.getElementById('watchNotes').value = '';
}

function removeWatch(index) {
    watchRules.splice(index, 1);
    updateWatchRulesDisplay();
    showNotification('Watch rule removed', 'success');
}

function updateWatchRulesDisplay() {
    const container = document.getElementById('watchRules');
    
    if (watchRules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p class="text-sm">No watch rules configured</p>
                <p class="text-xs mt-1">Add a rule above to start monitoring specific emails</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = watchRules.map((rule, index) => `
        <div class="flex justify-between items-center p-2 bg-blue-50 border border-blue-200 rounded">
            <div>
                <span class="font-medium">"${rule.subject}"</span>
                ${rule.sender ? `<span class="text-xs text-gray-600"> from: ${rule.sender}</span>` : ''}
                <span class="block text-xs text-gray-500">‚Üí ${rule.assignee}</span>
            </div>
            <button onclick="removeWatch(${index})" 
                    class="text-red-600 hover:text-red-800">
                ‚úï
            </button>
        </div>
    `).join('');
}

function showAddTeamMember() {
    document.getElementById('addTeamMemberModal').classList.remove('hidden');
}

function closeTeamMemberModal() {
    document.getElementById('addTeamMemberModal').classList.add('hidden');
    // Clear form
    document.getElementById('modalMemberName').value = '';
    document.getElementById('modalMemberPhone').value = '';
    document.getElementById('modalMemberRole').value = '';
}

function handleAddTeamMember(event) {
    event.preventDefault();
    
    const name = document.getElementById('modalMemberName').value.trim();
    const phone = document.getElementById('modalMemberPhone').value.trim();
    const role = document.getElementById('modalMemberRole').value.trim();
    
    // Validate phone format
    const phonePattern = /^[0-9]+@c\.us$/;
    if (!phonePattern.test(phone)) {
        showNotification('Invalid phone format. Use: 1234567890@c.us', 'error');
        return;
    }
    
    // Check if member already exists
    const existingMember = teamMembers.find(member => 
        member.name.toLowerCase() === name.toLowerCase() || member.phone === phone
    );
    
    if (existingMember) {
        showNotification('Team member with this name or phone already exists', 'error');
        return;
    }
    
    // Add the new member
    teamMembers.push({ 
        name: name, 
        phone: phone, 
        role: role || 'Team Member' 
    });
    
    updateTeamMemberOptions();
    closeTeamMemberModal();
    showNotification(`Team member added: ${name}`, 'success');
}

function updateTeamMemberOptions() {
    const select = document.getElementById('watchAssignee');
    const assigneeFilter = document.getElementById('assigneeFilter');
    
    // Update main select
    select.innerHTML = teamMembers.map(member => 
        `<option value="${member.name}">${member.name}</option>`
    ).join('');
    
    // Update filter select
    assigneeFilter.innerHTML = `
        <option value="">All Assignees</option>
        ${teamMembers.map(member => 
            `<option value="${member.name}">${member.name}</option>`
        ).join('')}
    `;
    
    // Update team members count
    document.getElementById('teamMembers').textContent = teamMembers.length;
}

function saveAutomationSettings() {
    const settings = {
        enableAutoScan: document.getElementById('enableAutoScan').checked,
        scanFrequency: document.getElementById('scanFrequency').value,
        customTimes: {
            time1: document.getElementById('scanTime1').value,
            time2: document.getElementById('scanTime2').value
        },
        notificationRoute: document.querySelector('input[name="notificationRoute"]:checked').value,
        enableSummary: document.getElementById('enableSummary').checked,
        watchRules: watchRules,
        teamMembers: teamMembers
    };
    
    // Here you would normally save to backend
    localStorage.setItem('gmailAutomationSettings', JSON.stringify(settings));
    showNotification('Automation settings saved successfully!', 'success');
}

function loadAutomationSettings() {
    const saved = localStorage.getItem('gmailAutomationSettings');
    if (!saved) return;
    
    try {
        const settings = JSON.parse(saved);
        
        document.getElementById('enableAutoScan').checked = settings.enableAutoScan ?? false; // Default OFF
        document.getElementById('scanFrequency').value = settings.scanFrequency || 'daily';
        document.getElementById('scanTime1').value = settings.customTimes?.time1 || '06:00';
        document.getElementById('scanTime2').value = settings.customTimes?.time2 || '18:00';
        document.getElementById('enableSummary').checked = settings.enableSummary ?? false; // Default OFF
        
        // Set notification route
        const routeRadio = document.querySelector(`input[name="notificationRoute"][value="${settings.notificationRoute || 'individual'}"]`);
        if (routeRadio) routeRadio.checked = true;
        
        // Load watch rules and team members
        if (settings.watchRules) {
            watchRules = settings.watchRules;
            updateWatchRulesDisplay();
        }
        
        if (settings.teamMembers) {
            teamMembers = settings.teamMembers;
            updateTeamMemberOptions();
        }
        
    } catch (e) {
        console.error('Error loading settings:', e);
    }
}

function showTeamManagement() {
    updateTeamMembersList();
    document.getElementById('teamManagementModal').classList.remove('hidden');
}

function closeTeamManagementModal() {
    document.getElementById('teamManagementModal').classList.add('hidden');
}

function updateTeamMembersList() {
    const container = document.getElementById('teamMembersList');
    container.innerHTML = teamMembers.map((member, index) => `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <div class="flex-1">
                <div class="font-medium">${member.name}</div>
                <div class="text-sm text-gray-600">${member.phone}</div>
                ${member.role ? `<div class="text-xs text-gray-500">${member.role}</div>` : ''}
            </div>
            <button onclick="removeTeamMember(${index})" 
                    class="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm">
                Remove
            </button>
        </div>
    `).join('');
}

function removeTeamMember(index) {
    const member = teamMembers[index];
    if (confirm(`Remove ${member.name} from team?`)) {
        teamMembers.splice(index, 1);
        updateTeamMembersList();
        updateTeamMemberOptions();
        showNotification(`${member.name} removed from team`, 'success');
    }
}

function showMessageTemplates() {
    document.getElementById('messageTemplatesModal').classList.remove('hidden');
}

function closeMessageTemplatesModal() {
    document.getElementById('messageTemplatesModal').classList.add('hidden');
}

function clearEmailHistory() {
    if (confirm('Clear all email processing history? This cannot be undone.')) {
        emailHistory = [];
        displayEmailHistory();
        updateStatistics();
        showNotification('Email history cleared', 'success');
    }
}

function resetSettings() {
    if (confirm('Reset all automation settings to defaults?')) {
        localStorage.removeItem('gmailAutomationSettings');
        location.reload();
    }
}

// Handle custom schedule visibility
document.getElementById('scanFrequency').addEventListener('change', function() {
    const customDiv = document.getElementById('customSchedule');
    if (this.value === 'custom') {
        customDiv.classList.remove('hidden');
    } else {
        customDiv.classList.add('hidden');
    }
});

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshHistory();
    loadAutomationSettings();
    updateWatchRulesDisplay();
    updateTeamMemberOptions();
});

function showNotification(message, type) {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Add event listeners for filters
document.getElementById('categoryFilter').addEventListener('change', displayEmailHistory);
document.getElementById('assigneeFilter').addEventListener('change', displayEmailHistory);
</script>
{% endblock %}