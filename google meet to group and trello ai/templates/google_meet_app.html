{% extends "base.html" %}

{% block title %}Google Meet to Trello - JGV EEsystems AI Hub{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Modern Header with Glassmorphism -->
    <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 p-8 text-white">
        <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
        <div class="relative z-10 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold mb-2">Google Meet AI Analyzer</h1>
                <p class="text-blue-100 text-lg">Transform meeting transcripts into actionable insights with GPT-4 intelligence</p>
                <div class="flex items-center space-x-4 mt-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-400/20 text-green-100 border border-green-400/30">
                        <i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>
                        AI Ready
                    </span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-400/20 text-purple-100 border border-purple-400/30">
                        <i data-lucide="zap" class="w-4 h-4 mr-1"></i>
                        GPT-4 Powered
                    </span>
                </div>
            </div>
            <div class="hidden md:block">
                <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md">
                    <i data-lucide="brain" class="w-10 h-10 text-white"></i>
                </div>
            </div>
        </div>
        <!-- Animated background elements -->
        <div class="absolute top-4 right-4 w-32 h-32 bg-white/5 rounded-full blur-xl"></div>
        <div class="absolute bottom-4 left-4 w-24 h-24 bg-white/5 rounded-full blur-xl"></div>
    </div>

    <!-- Main Processing Card with Glassmorphism -->
    <div class="relative backdrop-blur-xl bg-white/70 rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-white/40 to-white/10"></div>
        <div class="relative z-10 p-8">
            <div class="text-center mb-8">
                <div class="relative mx-auto mb-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg transform hover:scale-105 transition-transform duration-300">
                        <i data-lucide="brain" class="w-10 h-10 text-white"></i>
                    </div>
                    <div class="absolute -top-1 -right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <i data-lucide="check" class="w-3 h-3 text-white"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">AI-Powered Meeting Analysis</h2>
                <p class="text-gray-600 max-w-md mx-auto">Upload your meeting transcript and let our advanced AI identify relevant Trello cards, extract insights, and generate actionable summaries</p>
            </div>

            <form id="transcript-form" class="max-w-2xl mx-auto">
                <div class="space-y-4">
                    <!-- Modern Input Method Toggle -->
                    <div class="flex bg-gray-100 rounded-2xl p-1 mb-6">
                        <button type="button" id="text-tab" class="flex-1 py-3 px-4 text-sm font-medium rounded-xl transition-all duration-300 bg-white shadow-md text-blue-700 border border-blue-200">
                            <i data-lucide="type" class="w-4 h-4 inline mr-2"></i>
                            Direct Text
                        </button>
                        <button type="button" id="url-tab" class="flex-1 py-3 px-4 text-sm font-medium rounded-xl transition-all duration-300 text-gray-600 hover:bg-white/50">
                            <i data-lucide="link" class="w-4 h-4 inline mr-2"></i>
                            Google Doc
                        </button>
                        <button type="button" id="demo-tab" class="flex-1 py-3 px-4 text-sm font-medium rounded-xl transition-all duration-300 text-gray-600 hover:bg-white/50">
                            <i data-lucide="play-circle" class="w-4 h-4 inline mr-2"></i>
                            Demo
                        </button>
                    </div>

                    <!-- Modern Google Doc URL Input -->
                    <div id="url-input" class="input-section hidden">
                        <label for="google-doc-url" class="block text-sm font-medium text-gray-700 mb-3">
                            <i data-lucide="link" class="w-4 h-4 inline mr-2"></i>
                            Google Docs URL
                        </label>
                        <div class="relative group">
                            <input type="url" 
                                   id="google-doc-url" 
                                   name="url"
                                   placeholder="https://docs.google.com/document/d/..." 
                                   class="w-full px-5 py-4 pl-12 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-2xl focus:ring-4 focus:ring-green-500/20 focus:border-green-500 transition-all duration-300 text-gray-900 placeholder-gray-500">
                            <i data-lucide="link" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2 group-focus-within:text-green-500 transition-colors"></i>
                            <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-green-500/10 to-blue-500/10 opacity-0 group-focus-within:opacity-100 transition-opacity -z-10"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 flex items-center">
                            <i data-lucide="info" class="w-3 h-3 mr-1"></i>
                            Document must be publicly accessible or shared
                        </p>
                    </div>

                    <!-- Modern Direct Text Input -->
                    <div id="text-input" class="input-section">
                        <label for="direct-text" class="block text-sm font-medium text-gray-700 mb-3">
                            <i data-lucide="type" class="w-4 h-4 inline mr-2"></i>
                            Meeting Transcript
                        </label>
                        <div class="relative group">
                            <div id="drop-zone" class="relative border-2 border-dashed border-gray-300 rounded-2xl p-4 transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/50">
                                <textarea 
                                    id="direct-text"
                                    name="direct_text"
                                    rows="8"
                                    placeholder="Paste your meeting transcript here...

Example:
John: Let's review the WordPress project status
Sarah: The development is 80% complete, we need to focus on CENTER tasks
Mike: I'll handle the onboarded leads outreach this week"
                                    class="w-full px-5 py-4 bg-transparent border-none focus:ring-0 focus:outline-none text-gray-900 placeholder-gray-500 resize-none"></textarea>
                                
                                <!-- Drag and drop overlay -->
                                <div id="drop-overlay" class="absolute inset-0 bg-blue-500/10 backdrop-blur-sm rounded-2xl flex items-center justify-center hidden">
                                    <div class="text-center">
                                        <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-600 mx-auto mb-2"></i>
                                        <p class="text-blue-600 font-medium">Drop your transcript file here</p>
                                        <p class="text-blue-500 text-sm">Supports .txt, .docx files</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File upload button -->
                            <div class="mt-3 flex items-center justify-between">
                                <input type="file" id="file-input" accept=".txt,.docx" class="hidden">
                                <button type="button" id="upload-btn" class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition-colors">
                                    <i data-lucide="paperclip" class="w-4 h-4 mr-1"></i>
                                    Upload file instead
                                </button>
                                <div class="text-xs text-gray-500">
                                    <span id="char-count">0</span> characters
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-blue-600 mt-2 flex items-center">
                            <i data-lucide="lightbulb" class="w-3 h-3 mr-1"></i>
                            Include project names like "WordPress", "CENTER", "RULES" for better card matching
                        </p>
                    </div>

                    <!-- Modern Demo Mode -->
                    <div id="demo-input" class="input-section hidden">
                        <div class="relative bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-2xl p-6 overflow-hidden">
                            <div class="absolute inset-0 bg-white/40 backdrop-blur-sm"></div>
                            <div class="relative z-10">
                                <h4 class="font-semibold text-purple-900 mb-3 flex items-center">
                                    <i data-lucide="play-circle" class="w-5 h-5 mr-2"></i>
                                    Demo Mode
                                </h4>
                                <p class="text-sm text-purple-700 mb-4">
                                    Experience our AI-powered analysis with sample meeting data from your EEInteractive Trello board.
                                </p>
                                <div class="grid grid-cols-2 gap-3 text-xs text-purple-600">
                                    <div class="flex items-center">
                                        <i data-lucide="check" class="w-3 h-3 mr-2"></i>
                                        Sample transcript analysis
                                    </div>
                                    <div class="flex items-center">
                                        <i data-lucide="check" class="w-3 h-3 mr-2"></i>
                                        Real Trello card matching
                                    </div>
                                    <div class="flex items-center">
                                        <i data-lucide="check" class="w-3 h-3 mr-2"></i>
                                        AI comment generation
                                    </div>
                                    <div class="flex items-center">
                                        <i data-lucide="check" class="w-3 h-3 mr-2"></i>
                                        Safe testing environment
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Process Button -->
                    <button type="submit" 
                            id="process-btn"
                            class="group relative w-full bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 text-white font-bold py-5 px-8 rounded-2xl transition-all duration-500 flex items-center justify-center shadow-2xl transform hover:scale-[1.02] hover:shadow-3xl overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition-colors"></div>
                        <div class="relative z-10 flex items-center">
                            <i data-lucide="brain" class="w-6 h-6 mr-3"></i>
                            <span id="process-btn-text" class="text-lg">Analyze with AI</span>
                        </div>
                        <div class="absolute inset-0 -z-10 bg-gradient-to-r from-blue-400/20 to-purple-400/20 blur-xl group-hover:blur-2xl transition-all"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="bg-white rounded-xl shadow-md border border-gray-200 hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-600"></i>
                AI Analysis Results
            </h2>
        </div>
        <div class="p-6">
            <div id="results-content">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Features Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="brain" class="w-5 h-5 text-blue-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">AI-Powered Analysis</h3>
            </div>
            <p class="text-gray-600">Advanced AI analyzes speaking patterns, engagement levels, and meeting effectiveness with personalized feedback.</p>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5 text-purple-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Speaker Insights</h3>
            </div>
            <p class="text-gray-600">Individual performance metrics with personalized improvement suggestions sent via WhatsApp.</p>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i data-lucide="repeat" class="w-5 h-5 text-orange-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Recurring Tasks</h3>
            </div>
            <p class="text-gray-600">Automatically tracks tasks mentioned repeatedly across meetings to prevent items from falling through cracks.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const transcriptForm = document.getElementById('transcript-form');
    const processBtn = document.getElementById('process-btn');
    const processBtnText = document.getElementById('process-btn-text');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    
    // Tab elements
    const urlTab = document.getElementById('url-tab');
    const textTab = document.getElementById('text-tab');
    const demoTab = document.getElementById('demo-tab');
    
    // Input sections
    const urlInput = document.getElementById('url-input');
    const textInput = document.getElementById('text-input');
    const demoInput = document.getElementById('demo-input');
    
    let currentMode = 'text';

    // Modern tab switching functionality
    function switchTab(mode) {
        // Reset all tabs to inactive state
        [urlTab, textTab, demoTab].forEach(tab => {
            tab.classList.remove('bg-white', 'shadow-md', 'text-blue-700', 'border', 'border-blue-200', 
                                 'text-green-700', 'border-green-200', 'text-purple-700', 'border-purple-200');
            tab.classList.add('text-gray-600', 'hover:bg-white/50');
        });
        
        // Hide all input sections
        [urlInput, textInput, demoInput].forEach(section => {
            section.classList.add('hidden');
        });
        
        // Show selected tab and input
        currentMode = mode;
        
        if (mode === 'text') {
            textTab.classList.remove('text-gray-600', 'hover:bg-white/50');
            textTab.classList.add('bg-white', 'shadow-md', 'text-blue-700', 'border', 'border-blue-200');
            textInput.classList.remove('hidden');
            processBtnText.textContent = 'Analyze with AI';
        } else if (mode === 'url') {
            urlTab.classList.remove('text-gray-600', 'hover:bg-white/50');
            urlTab.classList.add('bg-white', 'shadow-md', 'text-green-700', 'border', 'border-green-200');
            urlInput.classList.remove('hidden');
            processBtnText.textContent = 'Process Document';
        } else if (mode === 'demo') {
            demoTab.classList.remove('text-gray-600', 'hover:bg-white/50');
            demoTab.classList.add('bg-white', 'shadow-md', 'text-purple-700', 'border', 'border-purple-200');
            demoInput.classList.remove('hidden');
            processBtnText.textContent = 'Try Demo';
        }
    }
    
    // Event listeners for tabs
    urlTab.addEventListener('click', () => switchTab('url'));
    textTab.addEventListener('click', () => switchTab('text'));
    demoTab.addEventListener('click', () => switchTab('demo'));
    
    transcriptForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let requestData = {};
        let endpoint = '/api/process-transcript';
        
        if (currentMode === 'url') {
            const url = document.getElementById('google-doc-url').value.trim();
            if (!url) {
                showNotification('Please enter a Google Docs URL', 'error');
                return;
            }
            requestData = { url: url };
        } else if (currentMode === 'text') {
            const text = document.getElementById('direct-text').value.trim();
            if (!text) {
                showNotification('Please enter meeting transcript text', 'error');
                return;
            }
            if (text.length < 50) {
                showNotification('Transcript too short. Please provide more content.', 'error');
                return;
            }
            requestData = { direct_text: text };
        } else if (currentMode === 'demo') {
            endpoint = '/api/demo-analyze';
            requestData = { demo_mode: true };
        }

        // Show progress overlay
        showProgressOverlay();
        const originalText = processBtn.innerHTML;
        showLoading(processBtn);
        resultsSection.classList.add('hidden');

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();
            console.log('Response received:', data);

            if (data.success) {
                const mode = currentMode === 'demo' ? 'Demo completed' : 'Analysis completed';
                console.log('Processing successful, calling showResults');
                hideProgressOverlay();
                showNotification(mode + ' successfully!', 'success');
                showResults(data);
            } else {
                console.log('Processing failed:', data.error);
                hideProgressOverlay();
                showNotification(data.error || 'Failed to process transcript', 'error');
            }
        } catch (error) {
            console.error('Error in processTranscript:', error);
            hideProgressOverlay();
            showNotification('Error processing transcript: ' + error.message, 'error');
        } finally {
            console.log('Finally block: hiding loading');
            hideLoading(processBtn, originalText);
        }
    });

    // Global workflow state
    let workflowData = {};
    let currentStep = 1;
    let realAttendees = [];
    let realCardAssignments = {};
    let googleDocUrl = "";

    function showResults(data) {
        console.log('showResults called with data:', data);
        workflowData = data;
        
        // Store the original transcript text
        if (currentMode === 'text') {
            workflowData.transcript_text = document.getElementById('direct-text').value.trim();
        }
        
        // Hide the upload form completely when showing results
        const transcriptForm = document.getElementById('transcript-form');
        if (transcriptForm) {
            transcriptForm.style.display = 'none';
        }
        
        try {
            // Extract real data from backend response with safety checks
            realAttendees = [];
            if (data.summary && data.summary.participants && Array.isArray(data.summary.participants)) {
                realAttendees = data.summary.participants;
                console.log('Real attendees extracted:', realAttendees);
            }
            
            // Extract Google Doc URL if available
            googleDocUrl = "";
            if (data.source_url) {
                googleDocUrl = data.source_url;
                console.log('Google Doc URL extracted:', googleDocUrl);
            }
            
            // Extract real card assignments from matched cards with safety checks
            realCardAssignments = {};
            if (data.matched_cards && Array.isArray(data.matched_cards)) {
                console.log('Processing matched cards:', data.matched_cards.length);
                data.matched_cards.forEach((card, index) => {
                    try {
                        if (card && card.assigned_members && Array.isArray(card.assigned_members)) {
                            card.assigned_members.forEach(member => {
                                if (member && typeof member === 'string') {
                                    if (!realCardAssignments[member]) {
                                        realCardAssignments[member] = [];
                                    }
                                    realCardAssignments[member].push({
                                        card_name: card.card_name || card.name || 'Unknown Card',
                                        card_url: card.url || '#',
                                        discussion_summary: card.comment_text || card.suggested_comment || 'Updates from meeting',
                                        quotes: extractQuotesFromComment(card.comment_text || card.suggested_comment || ''),
                                        actions: extractActionsFromComment(card.comment_text || card.suggested_comment || '')
                                    });
                                }
                            });
                        }
                    } catch (cardError) {
                        console.warn(`Error processing card ${index}:`, cardError);
                    }
                });
                console.log('Card assignments processed:', realCardAssignments);
            }
        } catch (error) {
            console.error('Error processing data:', error);
        }
        
        // Generate the workflow HTML with improved error handling
        try {
            resultsContent.innerHTML = generateWorkflowHTML(data);
            console.log('Workflow HTML generated successfully');
            
            // Show results
            resultsSection.classList.remove('hidden');
            lucide.createIcons();
            setupWorkflowEventListeners();
            
        } catch (error) {
            console.error('Error generating workflow:', error);
            // Fallback to simple display
            resultsContent.innerHTML = `
                <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">✅ Analysis Complete!</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900">Attendees:</h4>
                            <p class="text-gray-600">${realAttendees.length > 0 ? realAttendees.join(', ') : 'None detected'}</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Cards Found:</h4>
                            <p class="text-gray-600">${data.matched_cards ? data.matched_cards.length : 0} cards matched</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Start New Analysis
                        </button>
                    </div>
                </div>
            `;
            resultsSection.classList.remove('hidden');
        }
    }
    
    function generateWorkflowHTML(data) {
        console.log('Generating workflow HTML...');
        
        const cards = data.matched_cards || [];
        console.log('Cards to render:', cards.length);
        
        return `
            <!-- Progressive Workflow Container -->
            <div class="workflow-container space-y-8">
                <!-- Step 1: Trello Card Processing -->
                <div id="step-1" class="workflow-step active">
                    <div class="step-header mb-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Step 1: Trello Card Comments</h3>
                                <p class="text-gray-600">Review and edit AI-generated comments for matched Trello cards</p>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="step1-progress" class="h-full bg-gradient-to-r from-blue-600 to-purple-600 rounded-full transition-all duration-1000" style="width: 100%;"></div>
                        </div>
                    </div>

                    ${renderCards(cards)}
                </div>

                <!-- Step 2: Meeting Summary Messages -->
                <div id="step-2" class="workflow-step hidden">
                    <div class="step-header mb-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-blue-600 rounded-2xl flex items-center justify-center">
                                <i data-lucide="message-square" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Step 2: Meeting Summary Messages</h3>
                                <p class="text-gray-600">Group summary and individual assignee messages</p>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="step2-progress" class="h-full bg-gradient-to-r from-green-600 to-blue-600 rounded-full transition-all duration-1000" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div id="summary-section">
                        <!-- Summary content will be generated here -->
                    </div>
                </div>

                <!-- Step 3: In-Depth Analysis -->
                <div id="step-3" class="workflow-step hidden">
                    <div class="step-header mb-6">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                                <i data-lucide="brain" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Step 3: In-Depth Analysis</h3>
                                <p class="text-gray-600">Speaker analysis and meeting effectiveness insights</p>
                            </div>
                        </div>
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div id="step3-progress" class="h-full bg-gradient-to-r from-purple-600 to-indigo-600 rounded-full transition-all duration-1000" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div id="speaker-section">
                        <!-- Speaker analysis content will be generated here -->
                    </div>
                </div>
            </div>
        `;
    }

    function renderCards(cards) {
        console.log('renderCards called with:', cards);
        
        if (!cards || cards.length === 0) {
            return `
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="search" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Trello Cards Found</h3>
                    <p class="text-gray-600 mb-6">Try including specific project names like "WordPress", "CENTER", or "RULES" in your transcript.</p>
                    <button onclick="proceedToSummary()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Continue to Summary
                    </button>
                </div>
            `;
        }
        
        return `
            <div class="space-y-4 mb-8">
                ${cards.map((card, index) => {
                    const confidence = card.match_confidence || card.confidence || 0;
                    const cardId = card.card?.id || card.id || `card_${index}`;
                    const cardName = card.card?.name || card.card_name || card.name || 'Unknown Card';
                    const comment = card.comment_text || card.suggested_comment || '';

                    return `
                        <div class="relative bg-white/70 backdrop-blur-sm border border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all duration-300 card-item" data-card-id="${cardId}">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <label class="relative flex items-center cursor-pointer">
                                        <input type="checkbox" class="card-checkbox w-5 h-5 text-blue-600 rounded border-2 border-gray-300 focus:ring-blue-500" 
                                               data-card-id="${cardId}" 
                                               data-card-name="${cardName}"
                                               checked>
                                        <div class="absolute inset-0 bg-blue-600 text-white rounded opacity-0 peer-checked:opacity-100 transition-opacity flex items-center justify-center">
                                            <i data-lucide="check" class="w-3 h-3"></i>
                                        </div>
                                    </label>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${cardName}</h3>
                                        <div class="flex items-center space-x-4 text-sm text-gray-600">
                                            <span class="flex items-center">
                                                <i data-lucide="target" class="w-4 h-4 mr-1"></i>
                                                ${Math.round(confidence)}% match
                                            </span>
                                            <span class="flex items-center">
                                                <i data-lucide="layers" class="w-4 h-4 mr-1"></i>
                                                ${card.match_type || 'AI Match'}
                                            </span>
                                            ${card.card?.url ? `<a href="${card.card.url}" target="_blank" class="flex items-center text-blue-600 hover:text-blue-800"><i data-lucide="external-link" class="w-4 h-4 mr-1"></i>Open in Trello</a>` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                                        confidence >= 0.8 ? 'bg-green-100 text-green-800' : 
                                        confidence >= 0.6 ? 'bg-yellow-100 text-yellow-800' : 
                                        'bg-red-100 text-red-800'
                                    }">
                                        ${confidence >= 0.8 ? 'High Confidence' : confidence >= 0.6 ? 'Medium Confidence' : 'Low Confidence'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i data-lucide="edit-3" class="w-4 h-4 inline mr-1"></i>
                                    Proposed Comment (editable)
                                </label>
                                <textarea class="card-comment w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" 
                                          rows="3" 
                                          data-card-id="${cardId}">${comment}</textarea>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>

            <div class="flex items-center justify-between py-6 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <button id="select-all-cards" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                        Select All
                    </button>
                    <span class="text-sm text-gray-600">
                        <span id="selected-count">${cards.length}</span> of ${cards.length} selected
                    </span>
                </div>
                
                <div class="flex space-x-3">
                    <button id="skip-comments-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                        Skip Comments
                    </button>
                    <button id="send-to-trello-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center shadow-lg">
                        <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                        Send Comments to Trello
                    </button>
                </div>
            </div>
        `;
    }

    function setupWorkflowEventListeners() {
        console.log('Setting up workflow event listeners...');
        
        // Select all cards functionality
        const selectAllBtn = document.getElementById('select-all-cards');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.card-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(cb => cb.checked = !allChecked);
                updateSelectedCount();
                selectAllBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
            });
        }

        // Update selected count when checkboxes change
        document.querySelectorAll('.card-checkbox').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        // Send to Trello button
        const sendBtn = document.getElementById('send-to-trello-btn');
        if (sendBtn) {
            sendBtn.addEventListener('click', sendCommentsToTrello);
        }

        // Skip comments button
        const skipBtn = document.getElementById('skip-comments-btn');
        if (skipBtn) {
            skipBtn.addEventListener('click', () => {
                showNotification('Skipping Trello comments', 'info');
                proceedToSummary();
            });
        }
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.card-checkbox');
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const selectedCountEl = document.getElementById('selected-count');
        if (selectedCountEl) {
            selectedCountEl.textContent = checkedCount;
        }
    }

    async function sendCommentsToTrello() {
        console.log('sendCommentsToTrello called');
        const selectedCards = [];
        const checkboxes = document.querySelectorAll('.card-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            const cardId = checkbox.dataset.cardId;
            const cardName = checkbox.dataset.cardName;
            const commentTextarea = document.querySelector(`textarea[data-card-id="${cardId}"]`);
            const comment = commentTextarea ? commentTextarea.value : '';
            
            if (comment.trim()) {
                selectedCards.push({
                    card_id: cardId,
                    card_name: cardName,
                    comment: comment.trim()
                });
            }
        });

        if (selectedCards.length === 0) {
            showNotification('Please select at least one card with a comment', 'error');
            return;
        }

        const sendBtn = document.getElementById('send-to-trello-btn');
        const originalText = sendBtn.innerHTML;
        showLoading(sendBtn);

        try {
            const response = await fetch('/api/post-comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cards: selectedCards
                })
            });

            const result = await response.json();
            
            if (result.success) {
                showNotification(`Successfully posted ${result.comments_posted} comments to Trello!`, 'success');
                proceedToSummary();
            } else {
                throw new Error(result.error || 'Failed to post comments');
            }
        } catch (error) {
            showNotification('Error posting comments: ' + error.message, 'error');
        } finally {
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
        }
    }

    function proceedToSummary() {
        console.log('Proceeding to Step 2: Summary...');
        currentStep = 2;
        
        // Hide Step 1 and show Step 2
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        
        if (step1) {
            step1.classList.add('hidden');
        }
        
        if (step2) {
            step2.classList.remove('hidden');
            generateSummaryContent();
        } else {
            // Fallback if Step 2 doesn't exist in current workflow
            showNotification('Step 1 completed! Moving to summary...', 'success');
            resultsContent.innerHTML = generateCompletionHTML();
            lucide.createIcons();
        }
    }
    
    function generateSummaryContent() {
        console.log('Generating summary content...');
        const summarySection = document.getElementById('summary-section');
        
        if (!summarySection) {
            console.error('Summary section not found');
            return;
        }
        
        try {
            // Generate group summary message
            const groupSummary = generateGroupSummary();
            
            // Generate individual assignee messages
            const assigneeMessages = generateAssigneeMessages();
            
            summarySection.innerHTML = `
                <div class="space-y-6">
                    <!-- Group Summary -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="users" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Group Summary Message</h4>
                                <p class="text-sm text-gray-600">Overview message for the entire team</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                            <pre class="whitespace-pre-wrap text-sm text-gray-800">${groupSummary}</pre>
                        </div>
                    </div>
                    
                    <!-- Individual Messages -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="user-check" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Individual Assignee Messages</h4>
                                <p class="text-sm text-gray-600">Personalized messages for each team member</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${assigneeMessages}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-center space-x-4 pt-6">
                        <button onclick="proceedToCompletion()" class="px-6 py-3 text-gray-600 hover:text-gray-800 font-medium transition-colors border border-gray-300 rounded-xl">
                            Skip Messages
                        </button>
                        <button onclick="sendSummaryMessages()" class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 flex items-center shadow-lg">
                            <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                            Send Messages
                        </button>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            showNotification('Summary generated successfully!', 'success');
            
        } catch (error) {
            console.error('Error generating summary:', error);
            summarySection.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Error Generating Summary</h4>
                    <p class="text-gray-600 mb-4">${error.message}</p>
                    <button onclick="proceedToCompletion()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Skip to Completion
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
    }
    
    function generateGroupSummary() {
        const attendeeList = realAttendees.length > 0 ? realAttendees.join(', ') : 'Team members';
        const cardCount = Object.values(realCardAssignments).reduce((sum, cards) => sum + cards.length, 0);
        const docLink = googleDocUrl ? `\n\n📄 Meeting Notes: ${googleDocUrl}` : '';
        
        return `🎯 Meeting Summary - ${new Date().toLocaleDateString()}

👥 Attendees: ${attendeeList}
📋 Tasks Updated: ${cardCount} Trello cards
📝 Platform: Google Meet Transcript Analysis${docLink}

Key Outcomes:
${Object.entries(realCardAssignments).map(([member, cards]) => 
    `• ${member}: ${cards.length} task${cards.length !== 1 ? 's' : ''} assigned`
).join('\n') || '• No specific task assignments identified'}

All team members have been updated on their respective action items. Please check your assigned Trello cards for detailed comments and next steps.`;
    }
    
    function generateAssigneeMessages() {
        if (Object.keys(realCardAssignments).length === 0) {
            return `
                <div class="bg-white rounded-lg p-4 border border-gray-200 text-center">
                    <i data-lucide="info" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                    <p class="text-gray-600">No individual assignments found in this meeting.</p>
                </div>
            `;
        }
        
        return Object.entries(realCardAssignments).map(([member, cards]) => `
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-sm font-medium text-blue-600">${member[0]}</span>
                    </div>
                    <h5 class="font-medium text-gray-900">${member}</h5>
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${cards.length} task${cards.length !== 1 ? 's' : ''}</span>
                </div>
                <div class="text-sm text-gray-800 bg-gray-50 rounded p-3">
                    Hi ${member}! 👋
                    
                    You have ${cards.length} task${cards.length !== 1 ? 's' : ''} from today's meeting:
                    
                    ${cards.map((card, index) => `${index + 1}. ${card.card_name}
   ${card.discussion_summary}
   🔗 ${card.card_url}`).join('\n\n')}
                    ${googleDocUrl ? `\n📄 Full meeting notes: ${googleDocUrl}` : ''}
                </div>
            </div>
        `).join('');
    }
    
    function proceedToCompletion() {
        console.log('Proceeding to final completion...');
        resultsContent.innerHTML = generateCompletionHTML();
        lucide.createIcons();
    }
    
    function proceedToSpeakerAnalysis() {
        console.log('Proceeding to Step 3: Speaker Analysis...');
        currentStep = 3;
        
        // Hide Step 2 and show Step 3
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        
        if (step2) {
            step2.classList.add('hidden');
        }
        
        if (step3) {
            step3.classList.remove('hidden');
            generateSpeakerAnalysis();
        } else {
            // Fallback to completion if Step 3 doesn't exist
            proceedToCompletion();
        }
    }
    
    function generateSpeakerAnalysis() {
        console.log('Generating speaker analysis...');
        const speakerSection = document.getElementById('speaker-section');
        
        if (!speakerSection) {
            console.error('Speaker section not found');
            return;
        }
        
        // Show loading state
        speakerSection.innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                    <i data-lucide="brain" class="w-8 h-8 text-white"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Analyzing Speaker Patterns...</h3>
                <p class="text-gray-600 mb-6">Processing communication dynamics and meeting effectiveness</p>
                <div class="w-full bg-gray-200 rounded-full h-2 max-w-xs mx-auto">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                </div>
            </div>
        `;
        lucide.createIcons();
        
        // Update progress bar
        const step3Progress = document.getElementById('step3-progress');
        if (step3Progress) {
            step3Progress.style.width = '30%';
        }
        
        // Use the speaker analysis data from the original transcript processing
        if (workflowData.analysis_results && workflowData.analysis_results.speaker_analysis) {
            setTimeout(() => {
                displaySpeakerAnalysisResults(workflowData.analysis_results.speaker_analysis);
            }, 1500);
        } else {
            // Fallback: call API for speaker analysis
            setTimeout(() => {
                performSpeakerAnalysisAPI();
            }, 1500);
        }
    }
    
    function displaySpeakerAnalysisResults(speakerData) {
        const speakerSection = document.getElementById('speaker-section');
        
        // Update progress to 100%
        const step3Progress = document.getElementById('step3-progress');
        if (step3Progress) {
            step3Progress.style.width = '100%';
        }
        
        speakerSection.innerHTML = `
            <div class="space-y-6">
                <!-- Speaker Breakdown -->
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i data-lucide="users" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900">Speaker Analysis</h4>
                            <p class="text-sm text-gray-600">Communication patterns and participation metrics</p>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        ${generateSpeakerCards(speakerData)}
                    </div>
                </div>
                
                <!-- Meeting Effectiveness -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl p-6 border border-blue-200">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900">Meeting Effectiveness</h4>
                            <p class="text-sm text-gray-600">Analysis of discussion quality and outcomes</p>
                        </div>
                    </div>
                    ${generateEffectivenessMetrics(speakerData)}
                </div>
                
                <!-- Action Items Summary -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                            <i data-lucide="check-square" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900">Action Items & Decisions</h4>
                            <p class="text-sm text-gray-600">Summary of commitments and next steps</p>
                        </div>
                    </div>
                    ${generateActionItemsSummary()}
                </div>
                
                <!-- Completion Button -->
                <div class="text-center pt-6">
                    <button onclick="proceedToCompletion()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 flex items-center mx-auto shadow-lg">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        Complete Analysis
                    </button>
                </div>
            </div>
        `;
        lucide.createIcons();
        showNotification('Speaker analysis completed!', 'success');
    }
    
    function generateSpeakerCards(speakerData) {
        const speakers = speakerData.speakers || [];
        
        if (speakers.length === 0) {
            return `
                <div class="col-span-2 text-center py-4">
                    <p class="text-gray-600">No speaker data available</p>
                </div>
            `;
        }
        
        return speakers.map(speaker => {
            const engagement = speaker.engagement_level || 'medium';
            const engagementColor = engagement === 'high' ? 'text-green-600' : 
                                   engagement === 'low' ? 'text-red-600' : 'text-yellow-600';
            
            return `
                <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-blue-600">${speaker.name ? speaker.name[0] : '?'}</span>
                            </div>
                            <h5 class="font-medium text-gray-900">${speaker.name || 'Unknown'}</h5>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${engagementColor} bg-opacity-10 ${engagementColor.replace('text-', 'bg-')}">${engagement}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-500">Speaking Time:</span>
                            <span class="font-medium">${speaker.speaking_percentage || 0}%</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Questions:</span>
                            <span class="font-medium">${speaker.questions_asked || 0}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Contributions:</span>
                            <span class="font-medium">${speaker.contributions || 0}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Words:</span>
                            <span class="font-medium">${speaker.total_words || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function generateEffectivenessMetrics(speakerData) {
        const effectiveness = speakerData.effectiveness_score || 7.0;
        const effectivenessColor = effectiveness >= 8 ? 'text-green-600' : 
                                  effectiveness >= 6 ? 'text-yellow-600' : 'text-red-600';
        
        return `
            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg p-4 border border-gray-200 text-center">
                    <div class="text-2xl font-bold ${effectivenessColor}">${effectiveness}/10</div>
                    <div class="text-sm text-gray-600">Overall Score</div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-200 text-center">
                    <div class="text-2xl font-bold text-blue-600">${speakerData.total_speakers || realAttendees.length}</div>
                    <div class="text-sm text-gray-600">Participants</div>
                </div>
                <div class="bg-white rounded-lg p-4 border border-gray-200 text-center">
                    <div class="text-2xl font-bold text-purple-600">${speakerData.questions_asked || 0}</div>
                    <div class="text-sm text-gray-600">Questions Asked</div>
                </div>
            </div>
        `;
    }
    
    function generateActionItemsSummary() {
        const actionCount = Object.values(realCardAssignments).reduce((sum, cards) => sum + cards.length, 0);
        
        return `
            <div class="bg-white rounded-lg p-4 border border-gray-200">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">Action Items Assigned</h5>
                        <div class="text-2xl font-bold text-green-600 mb-2">${actionCount}</div>
                        <p class="text-sm text-gray-600">Cards updated in Trello with meeting context</p>
                    </div>
                    <div>
                        <h5 class="font-medium text-gray-900 mb-3">Team Members Involved</h5>
                        <div class="text-2xl font-bold text-blue-600 mb-2">${Object.keys(realCardAssignments).length}</div>
                        <p class="text-sm text-gray-600">Received individual task assignments</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    async function performSpeakerAnalysisAPI() {
        console.log('Performing speaker analysis via API...');
        
        try {
            const response = await fetch('/api/analyze-speakers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcript: workflowData.transcript_text || '',
                    cards_found: workflowData.matched_cards || []
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displaySpeakerAnalysisResults(data.speaker_analysis);
            } else {
                throw new Error(data.error || 'Speaker analysis failed');
            }
        } catch (error) {
            console.error('Speaker analysis error:', error);
            
            // Fallback to basic analysis
            const basicAnalysis = {
                speakers: realAttendees.map(name => ({
                    name: name,
                    engagement_level: 'medium',
                    speaking_percentage: Math.round(100 / realAttendees.length),
                    questions_asked: 1,
                    contributions: 2,
                    total_words: 50
                })),
                effectiveness_score: 7.0,
                total_speakers: realAttendees.length,
                questions_asked: realAttendees.length
            };
            
            displaySpeakerAnalysisResults(basicAnalysis);
        }
    }
    
    async function sendSummaryMessages() {
        console.log('Sending summary messages...');
        
        try {
            // Show loading state
            const sendBtn = document.querySelector('button[onclick="sendSummaryMessages()"]');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>Sending...';
            sendBtn.disabled = true;
            lucide.createIcons();
            
            // Send messages using the WhatsApp API
            const response = await fetch('/api/send-summary-messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    group_summary: generateGroupSummary(),
                    assignee_messages: realCardAssignments,
                    google_doc_url: googleDocUrl,
                    attendees: realAttendees
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`Successfully sent ${data.messages_sent} summary messages!`, 'success');
                proceedToSpeakerAnalysis();
            } else {
                throw new Error(data.error || 'Failed to send messages');
            }
            
        } catch (error) {
            console.error('Error sending summary messages:', error);
            showNotification('Error sending messages: ' + error.message, 'error');
            
            // Restore button
            const sendBtn = document.querySelector('button[onclick="sendSummaryMessages()"]');
            if (sendBtn) {
                sendBtn.innerHTML = '<i data-lucide="send" class="w-5 h-5 mr-2"></i>Send Messages';
                sendBtn.disabled = false;
                lucide.createIcons();
            }
        }
    }
    
    function generateCompletionHTML() {
        return `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Analysis Complete!</h3>
                <p class="text-gray-600 mb-6">Your meeting transcript has been processed and Trello cards updated.</p>
                <div class="space-y-3">
                    <div class="text-sm text-gray-600">
                        <strong>Attendees:</strong> ${realAttendees.join(', ') || 'None detected'}
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>Cards Updated:</strong> ${workflowData.cards_found || 0}
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>Source:</strong> ${googleDocUrl ? 'Google Doc' : 'Direct Text Input'}
                    </div>
                </div>
                <div class="mt-6 flex space-x-3 justify-center">
                    <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        Start New Analysis
                    </button>
                </div>
            </div>
        `;
    }

    // Helper functions for data extraction
    function extractQuotesFromComment(comment) {
        const quoteRegex = /"([^"]+)"/g;
        const quotes = [];
        let match;
        while ((match = quoteRegex.exec(comment)) !== null) {
            quotes.push(match[1]);
        }
        return quotes.length > 0 ? quotes : ['Discussion points from the meeting'];
    }
    
    function extractActionsFromComment(comment) {
        const lines = comment.split('\n');
        const actions = [];
        for (const line of lines) {
            if (line.trim().startsWith('•') || line.trim().startsWith('-')) {
                actions.push(line.trim().replace(/^[•-]\s*/, ''));
            }
        }
        return actions.length > 0 ? actions : ['Please check the card for details'];
    }

    // Progress overlay functions
    function showProgressOverlay() {
        console.log('Showing progress overlay...');
        
        const overlay = document.createElement('div');
        overlay.id = 'progress-overlay';
        overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center shadow-2xl">
                <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="brain" class="w-8 h-8 text-blue-600 animate-pulse"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">AI Analysis in Progress</h3>
                <p class="text-gray-600 mb-6">Processing your transcript with GPT-4 intelligence...</p>
                
                <div class="space-y-3">
                    <div class="progress-step flex items-center space-x-3">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-700">Analyzing transcript content</span>
                    </div>
                    <div class="progress-step flex items-center space-x-3">
                        <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                        <span class="text-sm text-gray-500">Matching Trello cards</span>
                    </div>
                    <div class="progress-step flex items-center space-x-3">
                        <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                        <span class="text-sm text-gray-500">Generating insights</span>
                    </div>
                    <div class="progress-step flex items-center space-x-3">
                        <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                        <span class="text-sm text-gray-500">Preparing results</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full animate-pulse" style="width: 25%"></div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        lucide.createIcons();
        
        // Animate progress steps
        let currentProgressStep = 0;
        const progressSteps = overlay.querySelectorAll('.progress-step');
        const progressBar = overlay.querySelector('.bg-blue-500');
        
        const progressInterval = setInterval(() => {
            if (currentProgressStep < progressSteps.length) {
                // Activate current step
                const step = progressSteps[currentProgressStep];
                const dot = step.querySelector('.w-2');
                const text = step.querySelector('.text-sm');
                
                dot.className = 'w-2 h-2 bg-blue-500 rounded-full animate-pulse';
                text.className = 'text-sm text-gray-700';
                
                // Update progress bar
                const progress = ((currentProgressStep + 1) / progressSteps.length) * 100;
                progressBar.style.width = progress + '%';
                
                currentProgressStep++;
            }
        }, 1500);
        
        // Store interval for cleanup
        overlay.dataset.intervalId = progressInterval;
    }
    
    function hideProgressOverlay() {
        console.log('Hiding progress overlay...');
        const overlay = document.getElementById('progress-overlay');
        if (overlay) {
            // Clear the interval
            const intervalId = overlay.dataset.intervalId;
            if (intervalId) {
                clearInterval(parseInt(intervalId));
            }
            
            // Fade out and remove
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.remove();
                }
            }, 300);
        }
    }

</script>
{% endblock %}
